<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DCCC Demo Console</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
    .card { background: white; border-radius: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .json-box { background: #f1f5f9; border-radius: 0.5rem; padding: 1rem; font-family: monospace; white-space: pre-wrap; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8">
  <div class="w-full max-w-3xl space-y-6">
    <header class="text-center">
      <h1 class="text-3xl font-bold text-gray-800">DaCloud Config Center â€” Demo</h1>
      <p class="text-gray-500 mt-1">Lightweight distributed config service (DCCC)</p>
    </header>

    <!-- Global Settings -->
    <div class="card p-6 space-y-4">
      <h2 class="text-xl font-semibold text-gray-700">API Settings</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-gray-600 mb-1">Base URL</label>
          <input id="baseUrl" value="https://dccc.dagedemo.workers.dev" class="w-full border rounded-lg px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Write Token</label>
          <input id="writeToken" value="Demo111+" class="w-full border rounded-lg px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Read Token</label>
          <input id="readToken" value="Demo222-" class="w-full border rounded-lg px-3 py-2" />
        </div>
      </div>
    </div>

    <!-- Query Area -->
    <div class="card p-6 space-y-4">
      <h2 class="text-xl font-semibold text-gray-700">Query / Manage Config</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm text-gray-600 mb-1">Service</label>
          <input id="service" value="dademo" class="w-full border rounded-lg px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Instance</label>
          <input id="instance" value="test" class="w-full border rounded-lg px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Key</label>
          <input id="key" value="timeout" class="w-full border rounded-lg px-3 py-2" />
        </div>
      </div>

      <div class="flex flex-wrap gap-3">
        <button id="btnQuery" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg">Query Key</button>
        <button id="btnList" class="bg-slate-600 hover:bg-slate-700 text-white font-medium px-4 py-2 rounded-lg">List All</button>
        <button id="btnPut" class="bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded-lg">Set Value</button>
        <button id="btnDelete" class="bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded-lg">Delete Key</button>
      </div>
    </div>

    <!-- Result Area -->
    <div class="card p-6">
      <h2 class="text-lg font-semibold text-gray-700 mb-2">Result</h2>
      <div id="result" class="json-box text-gray-700 text-sm">Ready.</div>
    </div>
  </div>

  <script>
    async function apiCall(path, options = {}, tokenType = "read") {
      const base = document.getElementById("baseUrl").value.trim();
      const token = (tokenType === "write" ? document.getElementById("writeToken") : document.getElementById("readToken")).value.trim();
      try {
        const res = await fetch(base + path, {
          ...options,
          headers: {
            ...(options.headers || {}),
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json",
          },
        });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = text; }
        if (!res.ok) throw new Error((data && data.error) || res.statusText);
        return data;
      } catch (err) {
        showResult({ error: err.message });
        throw err;
      }
    }

    function showResult(data) {
      const box = document.getElementById("result");
      box.textContent = JSON.stringify(data, null, 2);
    }

    document.getElementById("btnQuery").onclick = async () => {
      const s = service.value.trim();
      const i = instance.value.trim();
      const k = key.value.trim();
      try {
        const data = await apiCall(`/config?service=${s}&instance=${i}&key=${k}`, {}, "read");
        if (data.found) showResult({ key: data.key, value: data.value, source: data.source });
        else showResult({ message: "Key not found" });
      } catch {}
    };

    document.getElementById("btnList").onclick = async () => {
      const s = service.value.trim();
      const i = instance.value.trim();
      try {
        const data = await apiCall(`/configs?service=${s}&instance=${i}`, {}, "read");
        showResult(data);
      } catch {}
    };

    document.getElementById("btnPut").onclick = async () => {
      const s = service.value.trim();
      const i = instance.value.trim();
      const k = key.value.trim();
      const v = prompt("Enter new value:");
      if (v === null) return;
      try {
        const data = await apiCall("/config", {
          method: "PUT",
          body: JSON.stringify({ service: s, instance: i, key: k, value: v }),
        }, "write");
        showResult(data);
      } catch {}
    };

    document.getElementById("btnDelete").onclick = async () => {
      const s = service.value.trim();
      const i = instance.value.trim();
      const k = key.value.trim();
      if (!confirm(`Delete key "${k}"?`)) return;
      try {
        const data = await apiCall(`/config?service=${s}&instance=${i}&key=${k}`, { method: "DELETE" }, "write");
        showResult(data);
      } catch {}
    };
  </script>
</body>
</html>
